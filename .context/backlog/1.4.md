Gran decisión. Mi recomendación: **Opción B con “override/deltas” (B+)**.

* **Por defecto** los servicios heredan la cobertura del *provider* (80/20 de los casos y evita datos duplicados).
* **Cuando un servicio difiere** (p. ej., “Instalación eléctrica solo RM”, o “Asesoría remota para todo Chile”), el servicio puede:

  * **Override**: definir su cobertura completa propia, ignorando la del provider.
  * **Delta**: heredar y **agregar** o **excluir** regiones puntuales.

Esto te da simplicidad diaria + flexibilidad para los edge-cases sin duplicar coberturas en todos los servicios.

---

# Cambios de esquema (migración)

```sql
BEGIN;

-- 1) Estrategia de cobertura en service_products
ALTER TABLE service_products
  ADD COLUMN coverage_mode TEXT NOT NULL DEFAULT 'inherit'
  CHECK (coverage_mode IN ('inherit','override'));

-- 2) Deltas de cobertura por servicio
CREATE TABLE IF NOT EXISTS service_product_coverage_deltas (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  service_product_id UUID NOT NULL REFERENCES service_products(id) ON DELETE CASCADE,
  region_code TEXT NOT NULL REFERENCES regions_lkp(code) ON DELETE RESTRICT,
  op TEXT NOT NULL CHECK (op IN ('include','exclude')), -- include: suma; exclude: resta (solo en inherit)
  UNIQUE (service_product_id, region_code)
);
CREATE INDEX IF NOT EXISTS idx_sp_cov_deltas_spid
  ON service_product_coverage_deltas(service_product_id, op, region_code);

-- 3) Cobertura EFECTIVA de servicios (view para queries y filtros)
CREATE OR REPLACE VIEW service_product_effective_regions AS
-- A) override: usa SOLO los 'include' del servicio
SELECT sp.id AS service_product_id, d.region_code
FROM service_products sp
JOIN service_product_coverage_deltas d
  ON d.service_product_id = sp.id AND d.op='include'
WHERE sp.coverage_mode = 'override'
UNION
-- B1) inherit: hereda cobertura del provider, quitando 'exclude'
SELECT sp.id AS service_product_id, prov.region_code
FROM service_products sp
JOIN providers p ON p.id = sp.provider_id
JOIN provider_coverage_regions prov ON prov.provider_id = p.id
LEFT JOIN service_product_coverage_deltas ex
  ON ex.service_product_id = sp.id AND ex.op='exclude' AND ex.region_code = prov.region_code
WHERE sp.coverage_mode = 'inherit' AND ex.region_code IS NULL
UNION
-- B2) inherit: suma 'include' adicionales específicos del servicio
SELECT sp.id AS service_product_id, inc.region_code
FROM service_products sp
JOIN service_product_coverage_deltas inc
  ON inc.service_product_id = sp.id AND inc.op='include'
WHERE sp.coverage_mode = 'inherit';

COMMIT;
```

**Cómo filtrar servicios por región:**

```sql
SELECT s.*
FROM service_products s
JOIN service_product_effective_regions r
  ON r.service_product_id = s.id
WHERE r.region_code = 'RM';
```

---

# UI de Admin (formulario de Servicio)

**Sección “Cobertura”**

* Radio:

  * **Usar cobertura del proveedor (recomendado)** → `coverage_mode='inherit'`
  * **Definir cobertura para este servicio** → `coverage_mode='override'`

* Si `inherit` ➜ selector de regiones **tri-estado**:

  * “neutral” (heredar), “+ incluir” (crea delta `include`), “− excluir” (crea delta `exclude`).

* Si `override` ➜ checklist normal de regiones:

  * Guarda **solo** `include` en `service_product_coverage_deltas` (ignora `exclude`).

**Notas UX**

* Si un provider marca “Todo Chile”, simplemente pre-rellena todas las regiones en su cobertura; el servicio `inherit` lo reflejará sin duplicar datos.
* Mostrar *chip* “Cobertura efectiva: RM, V, VIII…” leyendo la **view** para validación visual.

---

# Impacto en API

* **GET `/service-products`**
  Parámetro `region` ahora filtra vía `service_product_effective_regions`.
* **PATCH `/service-products/:id`**
  Acepta `coverage_mode`.
  Añade endpoints internos para deltas:

  * `POST /service-products/:id/coverage/include { region_code }`
  * `POST /service-products/:id/coverage/exclude { region_code }`
  * `DELETE /service-products/:id/coverage/:region_code`

(Estos pueden ser “batch” si prefieres performance).

---

# Ventajas de B+

* **Sin duplicación**: la mayoría de los servicios no repiten cobertura del provider.
* **Flexible**: casos reales (servicio solo en RM, o asesoría nacional) se resuelven sin hacks.
* **Consultas limpias**: siempre filtras por la **view** efectiva.
* **Escalable**: si mañana agregas comunas/radios, puedes crear `*_coverage_deltas_geo` sin romper lo actual.

---

# Pruebas recomendadas

1. **Inherit + exclude**: Provider → RM, V. Servicio `inherit` con `exclude=V` ⇒ efectivo: RM.
2. **Inherit + include extra**: Provider → RM. Servicio `inherit` + `include=V` ⇒ efectivo: RM, V.
3. **Override full**: Provider → RM, V. Servicio `override` + `include=VIII` ⇒ efectivo: VIII solo.
4. **Filtros**: `/service-products?region=VIII` devuelve (2) y (3) correctamente.
5. **Permisos**: solo admin puede mutar deltas; público solo GET.

---

Si te hace sentido, lo dejo como **decisión aprobada** y marco tus TODOs para:

* migrar schema,
* actualizar ServiceForm (radio + tri-estado),
* ajustar endpoints de listado con `JOIN service_product_effective_regions`,
* y tests de cobertura efectiva. ¿Vamos con eso?
