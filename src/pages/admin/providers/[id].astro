---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getAdminAuth, requireAdmin } from '../../../lib/auth';
import { createSupabaseClient } from '../../../lib/supabase';

// Protect this page - only admins can access
const auth = await getAdminAuth(Astro);
const user = requireAdmin(auth);

if (!user) {
  return Astro.redirect('/auth/login?redirect=/admin/providers');
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/providers');
}

// Fetch provider data
const supabase = createSupabaseClient(Astro);

// Log for debugging
console.log('Attempting to fetch provider with ID:', id);

const { data: provider, error } = await supabase
  .from('providers')
  .select('*')
  .eq('id', id)
  .single();

// Log for debugging
console.log('Provider fetch result:', { provider, error });

if (error || !provider) {
  console.error('Provider not found. Error:', error);
  return Astro.redirect('/admin/providers?error=Provider not found');
}

// Helper function to format date
const formatDate = (dateString: string | null) => {
  if (!dateString) return 'No establecido';
  return new Date(dateString).toLocaleDateString('es-CL', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
};

// Helper function to format currency
const formatCurrency = (amount: number | null) => {
  if (!amount) return 'No especificado';
  return new Intl.NumberFormat('es-CL', {
    style: 'currency',
    currency: 'CLP'
  }).format(amount);
};

// Helper function to get status badge class
const getStatusBadge = (status: string | null) => {
  const badges: Record<string, string> = {
    'active': 'bg-green-100 text-green-800',
    'pending_review': 'bg-yellow-100 text-yellow-800',
    'draft': 'bg-gray-100 text-gray-800',
    'inactive': 'bg-red-100 text-red-800',
    'rejected': 'bg-red-100 text-red-800'
  };
  return badges[status || ''] || 'bg-gray-100 text-gray-800';
};

// Helper function to get tier badge class
const getTierBadge = (tier: string | null) => {
  const badges: Record<string, string> = {
    'destacado': 'bg-purple-100 text-purple-800',
    'premium': 'bg-blue-100 text-blue-800',
    'standard': 'bg-gray-100 text-gray-800'
  };
  return badges[tier || ''] || 'bg-gray-100 text-gray-800';
};
---

<AdminLayout title={`${provider.company_name} - Detalles`} user={user} currentPage="/admin/providers">
  <div class="p-6">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-4">
          <a 
            href="/admin/providers" 
            class="text-gray-600 hover:text-gray-900"
          >
            ‚Üê Volver a Proveedores
          </a>
        </div>
        <div class="flex space-x-3">
          <a
            href={`/admin/providers/${id}/edit`}
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            ‚úèÔ∏è Editar
          </a>
          <button
            onclick={`deleteProvider('${id}', '${provider.company_name}')`}
            class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
          >
            üóëÔ∏è Eliminar
          </button>
        </div>
      </div>
      
      <div class="flex items-center space-x-4">
        {provider.logo_url && (
          <img 
            src={provider.logo_url} 
            alt={`${provider.company_name} logo`}
            class="w-16 h-16 rounded-lg object-cover border"
          />
        )}
        <div>
          <h1 class="text-2xl font-bold text-gray-900">{provider.company_name}</h1>
          <div class="flex items-center space-x-3 mt-2">
            <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadge(provider.status)}`}>
              {provider.status === 'active' ? 'Activo' :
               provider.status === 'pending_review' ? 'Pendiente' :
               provider.status === 'draft' ? 'Borrador' :
               provider.status === 'inactive' ? 'Inactivo' : 'Rechazado'}
            </span>
            <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getTierBadge(provider.tier)}`}>
              {provider.tier === 'destacado' ? 'Destacado' :
               provider.tier === 'premium' ? 'Premium' : 'Est√°ndar'}
            </span>
            {provider.featured_until && new Date(provider.featured_until) > new Date() && (
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                ‚≠ê Destacado
              </span>
            )}
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column - Main Info -->
      <div class="lg:col-span-2 space-y-6">
        
        <!-- Basic Information -->
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Informaci√≥n B√°sica</h2>
          </div>
          <div class="p-6">
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Nombre de la Empresa</dt>
                <dd class="mt-1 text-sm text-gray-900">{provider.company_name}</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Email</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <a href={`mailto:${provider.email}`} class="text-blue-600 hover:text-blue-800">
                    {provider.email}
                  </a>
                </dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Tel√©fono</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  <a href={`tel:${provider.phone}`} class="text-blue-600 hover:text-blue-800">
                    {provider.phone}
                  </a>
                </dd>
              </div>
              {provider.whatsapp && (
                <div>
                  <dt class="text-sm font-medium text-gray-500">WhatsApp</dt>
                  <dd class="mt-1 text-sm text-gray-900">
                    <a href={`https://wa.me/${provider.whatsapp?.replace(/[^0-9]/g, '') || ''}`} class="text-blue-600 hover:text-blue-800">
                      {provider.whatsapp}
                    </a>
                  </dd>
                </div>
              )}
              {provider.website && (
                <div>
                  <dt class="text-sm font-medium text-gray-500">Sitio Web</dt>
                  <dd class="mt-1 text-sm text-gray-900">
                    <a href={provider.website} target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800">
                      {provider.website}
                    </a>
                  </dd>
                </div>
              )}
              <div>
                <dt class="text-sm font-medium text-gray-500">Categor√≠a</dt>
                <dd class="mt-1 text-sm text-gray-900">
                  {provider.category_type === 'fabricantes' ? 'Fabricantes de Casas' :
                   provider.category_type === 'habilitacion_servicios' ? 'Habilitaci√≥n y Servicios' :
                   provider.category_type === 'decoracion' ? 'Decoraci√≥n y Mejoras' : provider.category_type}
                </dd>
              </div>
            </dl>
            
            {provider.description && (
              <div class="mt-6">
                <dt class="text-sm font-medium text-gray-500">Descripci√≥n</dt>
                <dd class="mt-2 text-sm text-gray-900">{provider.description}</dd>
              </div>
            )}
          </div>
        </div>

        <!-- Location Information -->
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Ubicaci√≥n</h2>
          </div>
          <div class="p-6">
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
              {provider.address && (
                <div class="md:col-span-2">
                  <dt class="text-sm font-medium text-gray-500">Direcci√≥n</dt>
                  <dd class="mt-1 text-sm text-gray-900">{provider.address}</dd>
                </div>
              )}
              {provider.city && (
                <div>
                  <dt class="text-sm font-medium text-gray-500">Ciudad</dt>
                  <dd class="mt-1 text-sm text-gray-900">{provider.city}</dd>
                </div>
              )}
              {provider.region && (
                <div>
                  <dt class="text-sm font-medium text-gray-500">Regi√≥n</dt>
                  <dd class="mt-1 text-sm text-gray-900">{provider.region}</dd>
                </div>
              )}
            </dl>
          </div>
        </div>

        <!-- Business Details -->
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Detalles del Negocio</h2>
          </div>
          <div class="p-6">
            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
              {provider.years_experience && (
                <div>
                  <dt class="text-sm font-medium text-gray-500">A√±os de Experiencia</dt>
                  <dd class="mt-1 text-sm text-gray-900">{provider.years_experience} a√±os</dd>
                </div>
              )}
              <div>
                <dt class="text-sm font-medium text-gray-500">Llave en Mano</dt>
                <dd class="mt-1 text-sm text-gray-900">{provider.llave_en_mano ? 'S√≠' : 'No'}</dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Financiamiento</dt>
                <dd class="mt-1 text-sm text-gray-900">{provider.financing_available ? 'Disponible' : 'No disponible'}</dd>
              </div>
            </dl>

            {provider.specialties && provider.specialties.length > 0 && (
              <div class="mt-6">
                <dt class="text-sm font-medium text-gray-500">Especialidades</dt>
                <dd class="mt-2">
                  <div class="flex flex-wrap gap-2">
                    {provider.specialties.map((specialty: string) => (
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        {specialty}
                      </span>
                    ))}
                  </div>
                </dd>
              </div>
            )}

            {provider.services_offered && provider.services_offered.length > 0 && (
              <div class="mt-6">
                <dt class="text-sm font-medium text-gray-500">Servicios Ofrecidos</dt>
                <dd class="mt-2">
                  <div class="flex flex-wrap gap-2">
                    {provider.services_offered.map((service: string) => (
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        {service}
                      </span>
                    ))}
                  </div>
                </dd>
              </div>
            )}

            {provider.coverage_areas && provider.coverage_areas.length > 0 && (
              <div class="mt-6">
                <dt class="text-sm font-medium text-gray-500">√Åreas de Cobertura</dt>
                <dd class="mt-2">
                  <div class="flex flex-wrap gap-2">
                    {provider.coverage_areas.map((area: string) => (
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        {area}
                      </span>
                    ))}
                  </div>
                </dd>
              </div>
            )}
          </div>
        </div>

        <!-- Pricing Information -->
        {(provider.price_range_min || provider.price_range_max || provider.price_per_m2_min || provider.price_per_m2_max) && (
          <div class="bg-white rounded-lg border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
              <h2 class="text-lg font-medium text-gray-900">Precios</h2>
            </div>
            <div class="p-6">
              <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {(provider.price_range_min || provider.price_range_max) && (
                  <div>
                    <dt class="text-sm font-medium text-gray-500">Rango de Precios</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                      {formatCurrency(provider.price_range_min)} - {formatCurrency(provider.price_range_max)}
                    </dd>
                  </div>
                )}
                {(provider.price_per_m2_min || provider.price_per_m2_max) && (
                  <div>
                    <dt class="text-sm font-medium text-gray-500">Precio por m¬≤</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                      {formatCurrency(provider.price_per_m2_min)} - {formatCurrency(provider.price_per_m2_max)}
                    </dd>
                  </div>
                )}
              </dl>
            </div>
          </div>
        )}
      </div>

      <!-- Right Column - Metadata & Actions -->
      <div class="space-y-6">
        
        <!-- Status & Tier -->
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Estado y Configuraci√≥n</h2>
          </div>
          <div class="p-6">
            <dl class="space-y-4">
              <div>
                <dt class="text-sm font-medium text-gray-500">Estado</dt>
                <dd class="mt-1">
                  <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusBadge(provider.status)}`}>
                    {provider.status === 'active' ? 'Activo' :
                     provider.status === 'pending_review' ? 'Pendiente' :
                     provider.status === 'draft' ? 'Borrador' :
                     provider.status === 'inactive' ? 'Inactivo' : 'Rechazado'}
                  </span>
                </dd>
              </div>
              <div>
                <dt class="text-sm font-medium text-gray-500">Nivel</dt>
                <dd class="mt-1">
                  <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getTierBadge(provider.tier)}`}>
                    {provider.tier === 'destacado' ? 'Destacado' :
                     provider.tier === 'premium' ? 'Premium' : 'Est√°ndar'}
                  </span>
                </dd>
              </div>
              {provider.internal_rating && (
                <div>
                  <dt class="text-sm font-medium text-gray-500">Calificaci√≥n Interna</dt>
                  <dd class="mt-1 text-sm text-gray-900">
                    {'‚≠ê'.repeat(provider.internal_rating)} ({provider.internal_rating}/5)
                  </dd>
                </div>
              )}
              {provider.featured_until && (
                <div>
                  <dt class="text-sm font-medium text-gray-500">Destacado hasta</dt>
                  <dd class="mt-1 text-sm text-gray-900">{formatDate(provider.featured_until)}</dd>
                </div>
              )}
              {provider.premium_until && (
                <div>
                  <dt class="text-sm font-medium text-gray-500">Premium hasta</dt>
                  <dd class="mt-1 text-sm text-gray-900">{formatDate(provider.premium_until)}</dd>
                </div>
              )}
            </dl>
          </div>
        </div>

        <!-- Metadata -->
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">Metadatos</h2>
          </div>
          <div class="p-6">
            <dl class="space-y-4 text-sm">
              <div>
                <dt class="font-medium text-gray-500">Creado</dt>
                <dd class="text-gray-900">{formatDate(provider.created_at)}</dd>
              </div>
              <div>
                <dt class="font-medium text-gray-500">√öltima Actualizaci√≥n</dt>
                <dd class="text-gray-900">{formatDate(provider.updated_at)}</dd>
              </div>
              {provider.approved_at && (
                <div>
                  <dt class="font-medium text-gray-500">Aprobado</dt>
                  <dd class="text-gray-900">{formatDate(provider.approved_at)}</dd>
                </div>
              )}
              <div>
                <dt class="font-medium text-gray-500">Slug</dt>
                <dd class="text-gray-900 font-mono text-xs">{provider.slug}</dd>
              </div>
            </dl>
          </div>
        </div>

        <!-- Admin Notes -->
        {provider.admin_notes && (
          <div class="bg-yellow-50 rounded-lg border border-yellow-200">
            <div class="px-6 py-4 border-b border-yellow-200">
              <h2 class="text-lg font-medium text-yellow-900">Notas Administrativas</h2>
            </div>
            <div class="p-6">
              <p class="text-sm text-yellow-800">{provider.admin_notes}</p>
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
</AdminLayout>

<script is:inline>
  function deleteProvider(id, name) {
    if (confirm(`¬øEst√°s seguro de que deseas eliminar al proveedor "${name}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
      fetch(`/api/admin/providers/${id}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Proveedor eliminado exitosamente');
          window.location.href = '/admin/providers';
        } else {
          alert('Error al eliminar el proveedor: ' + (data.error || 'Error desconocido'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error de conexi√≥n. Int√©ntalo de nuevo.');
      });
    }
  }
</script>