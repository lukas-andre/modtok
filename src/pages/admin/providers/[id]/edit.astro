---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { getAdminAuth, requireAdmin } from '@/lib/auth';
import { createSupabaseClient } from '@/lib/supabase';
import ProviderForm from '@/components/admin/forms/ProviderForm';
import ManufacturerProfileEditor from '@/components/admin/forms/ManufacturerProfileEditor';

// Protect this page - only admins can access
const auth = await getAdminAuth(Astro);
const user = requireAdmin(auth);

if (!user) {
  return Astro.redirect('/auth/login?redirect=/admin/providers');
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/providers');
}

// Fetch provider data
const supabase = createSupabaseClient(Astro);
const { data: provider, error } = await supabase
  .from('providers')
  .select('*')
  .eq('id', id)
  .single();

if (error || !provider) {
  return Astro.redirect('/admin/providers?error=Provider not found');
}

// Fetch coverage regions
const { data: coverageData } = await supabase
  .from('provider_coverage_regions')
  .select('region_code')
  .eq('provider_id', id);

const coverage_regions = coverageData?.map(r => r.region_code) || [];

// Prepare initial data for the form - Provider minimalista
const initialData = {
  // Identity
  company_name: provider.company_name,
  slug: provider.slug,
  email: provider.email,
  phone: provider.phone,
  website: provider.website,
  whatsapp: provider.whatsapp,
  description: provider.description,

  // HQ Location
  address: provider.address,
  city: provider.city,
  hq_region_code: provider.hq_region_code,

  // Capabilities
  is_manufacturer: provider.is_manufacturer || false,
  is_service_provider: provider.is_service_provider || false,

  // Coverage
  coverage_regions: coverage_regions,

  // Moderation
  status: provider.status,
  admin_notes: provider.admin_notes || ''
};
---

<AdminLayout title={`Editar ${provider.company_name}`} user={user} currentPage="/admin/providers">
  <div class="p-6">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <a
          href={`/admin/providers/${id}`}
          class="text-gray-600 hover:text-gray-900 flex items-center"
        >
          <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Volver al Proveedor
        </a>

        <!-- Provider Status Badge -->
        <span class={`px-3 py-1 text-sm font-medium rounded-full ${
          provider.status === 'active' ? 'bg-green-100 text-green-800' :
          provider.status === 'pending_review' ? 'bg-yellow-100 text-yellow-800' :
          provider.status === 'draft' ? 'bg-gray-100 text-gray-800' :
          provider.status === 'inactive' ? 'bg-gray-100 text-gray-600' :
          'bg-red-100 text-red-800'
        }`}>
          {provider.status === 'active' ? '‚úì Activo' :
           provider.status === 'pending_review' ? '‚è≥ Pendiente' :
           provider.status === 'draft' ? 'üìù Borrador' :
           provider.status === 'inactive' ? '‚è∏ Inactivo' :
           '‚úó Rechazado'}
        </span>
      </div>

      <h2 class="text-2xl font-bold text-gray-900">Editar Proveedor</h2>
      <p class="text-gray-600 mt-1">{provider.company_name}</p>

      <!-- Services Badges -->
      <div class="flex items-center space-x-2 mt-3">
        {provider.is_manufacturer && (
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
            üè≠ Fabricante
          </span>
        )}
        {provider.is_service_provider && (
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
            üîß H&S
          </span>
        )}
        {!provider.is_manufacturer && !provider.is_service_provider && (
          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
            ‚ö†Ô∏è Sin servicios definidos
          </span>
        )}
      </div>
    </div>

    <!-- Info Box -->
    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <div class="flex items-start">
        <svg class="w-5 h-5 text-blue-400 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
          <p class="text-blue-800 font-medium">Modelo de Servicios M√∫ltiples</p>
          <p class="text-blue-700 text-sm mt-1">
            Este proveedor puede ofrecer m√∫ltiples servicios. Las features se mostrar√°n din√°micamente seg√∫n los servicios seleccionados.
          </p>
        </div>
      </div>
    </div>

    <!-- Form Component -->
    <ProviderForm
      client:load
      mode="edit"
      providerId={id}
      initialData={initialData}
    />

    <!-- Manufacturer Profile Editor (solo para fabricantes) -->
    {provider.is_manufacturer && (
      <div class="mt-12 pt-8 border-t border-gray-300">
        <div class="mb-6">
          <h3 class="text-xl font-bold text-gray-900 mb-2">
            üè≠ Perfil de Fabricante
          </h3>
          <p class="text-gray-600">
            Gestiona las capacidades declaradas del fabricante. Estas capacidades se combinan con las verificadas desde las casas publicadas.
          </p>
        </div>

        <ManufacturerProfileEditor
          client:load
          providerId={id}
          companyName={provider.company_name}
        />
      </div>
    )}
  </div>
</AdminLayout>
