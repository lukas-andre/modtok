---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getAdminAuth, requireAdmin } from '../../../lib/auth';
import { createSupabaseClient } from '../../../lib/supabase';

// Protect this page - only admins can access
const auth = await getAdminAuth(Astro);
const user = requireAdmin(auth);

if (!user) {
  return Astro.redirect('/auth/login?redirect=/admin/providers/create');
}

// Fetch features data based on CSV structure
const supabase = createSupabaseClient(Astro);
const { data: features } = await supabase
  .from('features')
  .select('*')
  .order('category_id', { ascending: true });

const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .order('display_order', { ascending: true });

// Group features by category for easier rendering
const featuresByCategory = features?.reduce((acc, feature) => {
  const categoryId = feature.category_id;
  if (categoryId && !acc[categoryId]) {
    acc[categoryId] = [];
  }
  if (categoryId) {
    acc[categoryId].push(feature);
  }
  return acc;
}, {} as Record<string, typeof features>);
---

<AdminLayout title="Crear Proveedor" user={user} currentPage="/admin/providers">
  <div class="p-6">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center space-x-4 mb-4">
        <a 
          href="/admin/providers" 
          class="text-gray-600 hover:text-gray-900"
        >
          ← Volver a Proveedores
        </a>
      </div>
      <h2 class="text-xl font-semibold text-gray-900">Crear Nuevo Proveedor</h2>
      <p class="text-gray-600 mt-1">Registra un nuevo proveedor en la plataforma MODTOK</p>
    </div>

    <!-- Success/Error Messages -->
    <div id="successMessage" class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg hidden">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-green-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <p class="text-green-800 font-medium">
          ¡Proveedor creado exitosamente! Se ha enviado un email con las credenciales.
        </p>
      </div>
    </div>

    <div id="errorMessage" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg hidden">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-red-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
        <p class="text-red-800 font-medium" id="errorText"></p>
      </div>
    </div>

    <form id="createProviderForm" class="space-y-8">
      <!-- Company Information -->
      <div class="bg-white rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-900">Información de la Empresa</h3>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2">
            <label for="company_name" class="block text-sm font-medium text-gray-700 mb-2">
              Nombre de la Empresa *
            </label>
            <input
              type="text"
              id="company_name"
              name="company_name"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: Construcciones Modular Chile"
            />
          </div>

          <div>
            <label for="contact_name" class="block text-sm font-medium text-gray-700 mb-2">
              Nombre del Contacto *
            </label>
            <input
              type="text"
              id="contact_name"
              name="contact_name"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: Juan Pérez"
            />
          </div>

          <div>
            <label for="rut" class="block text-sm font-medium text-gray-700 mb-2">
              RUT de la Empresa *
            </label>
            <input
              type="text"
              id="rut"
              name="rut"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: 12.345.678-9"
            />
          </div>

          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Correo Electrónico *
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="contacto@empresa.cl"
            />
          </div>

          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
              Teléfono *
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="+56 9 1234 5678"
            />
          </div>

          <div class="md:col-span-2">
            <label for="website" class="block text-sm font-medium text-gray-700 mb-2">
              Sitio Web
            </label>
            <input
              type="url"
              id="website"
              name="website"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="https://www.empresa.cl"
            />
          </div>

          <div class="md:col-span-2">
            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
              Descripción de la Empresa
            </label>
            <textarea
              id="description"
              name="description"
              rows="4"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Describe los servicios y especialidades de la empresa..."
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Location Information -->
      <div class="bg-white rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-900">Ubicación</h3>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="md:col-span-2">
            <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
              Dirección *
            </label>
            <input
              type="text"
              id="address"
              name="address"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: Av. Providencia 1234"
            />
          </div>

          <div>
            <label for="city" class="block text-sm font-medium text-gray-700 mb-2">
              Ciudad *
            </label>
            <input
              type="text"
              id="city"
              name="city"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: Santiago"
            />
          </div>

          <div>
            <label for="region" class="block text-sm font-medium text-gray-700 mb-2">
              Región *
            </label>
            <select
              id="region"
              name="region"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Seleccionar región...</option>
              <option value="Región de Arica y Parinacota">Región de Arica y Parinacota</option>
              <option value="Región de Tarapacá">Región de Tarapacá</option>
              <option value="Región de Antofagasta">Región de Antofagasta</option>
              <option value="Región de Atacama">Región de Atacama</option>
              <option value="Región de Coquimbo">Región de Coquimbo</option>
              <option value="Región de Valparaíso">Región de Valparaíso</option>
              <option value="Región Metropolitana">Región Metropolitana</option>
              <option value="Región del Libertador General Bernardo O'Higgins">Región del Libertador General Bernardo O'Higgins</option>
              <option value="Región del Maule">Región del Maule</option>
              <option value="Región de Ñuble">Región de Ñuble</option>
              <option value="Región del Biobío">Región del Biobío</option>
              <option value="Región de La Araucanía">Región de La Araucanía</option>
              <option value="Región de Los Ríos">Región de Los Ríos</option>
              <option value="Región de Los Lagos">Región de Los Lagos</option>
              <option value="Región Aysén del General Carlos Ibáñez del Campo">Región Aysén del General Carlos Ibáñez del Campo</option>
              <option value="Región de Magallanes y de la Antártica Chilena">Región de Magallanes y de la Antártica Chilena</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Provider Configuration -->
      <div class="bg-white rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-900">Configuración del Proveedor</h3>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="tier" class="block text-sm font-medium text-gray-700 mb-2">
              Nivel de Proveedor *
            </label>
            <select
              id="tier"
              name="tier"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="standard">Estándar</option>
              <option value="premium">Premium</option>
              <option value="destacado">Destacado</option>
            </select>
            <p class="mt-2 text-sm text-gray-600">
              <strong>Estándar:</strong> Perfil básico<br/>
              <strong>Premium:</strong> Mayor visibilidad y funciones<br/>
              <strong>Destacado:</strong> Máxima visibilidad
            </p>
          </div>

          <div>
            <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
              Estado *
            </label>
            <select
              id="status"
              name="status"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="draft">Borrador</option>
              <option value="pending_review">Pendiente de Revisión</option>
              <option value="active">Activo</option>
              <option value="inactive">Inactivo</option>
              <option value="rejected">Rechazado</option>
            </select>
          </div>

          <div>
            <label for="temp_password" class="block text-sm font-medium text-gray-700 mb-2">
              Contraseña Temporal *
            </label>
            <input
              type="password"
              id="temp_password"
              name="temp_password"
              required
              minlength="8"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Mínimo 8 caracteres"
            />
          </div>

          <div class="flex items-end">
            <button
              type="button"
              onclick="generatePassword()"
              class="px-4 py-2 text-blue-600 hover:text-blue-800 text-sm font-medium border border-blue-300 rounded-md hover:bg-blue-50"
            >
              🎲 Generar contraseña
            </button>
          </div>

          <div class="md:col-span-2">
            <label for="admin_notes" class="block text-sm font-medium text-gray-700 mb-2">
              Notas Administrativas
            </label>
            <textarea
              id="admin_notes"
              name="admin_notes"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Notas internas para administradores..."
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Categories -->
      <div class="bg-white rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-900">Categorías del Proveedor</h3>
        </div>
        <div class="p-6">
          <label class="block text-sm font-medium text-gray-700 mb-3">
            Seleccione las categorías que ofrece este proveedor * (puede seleccionar múltiples)
          </label>
          <div class="space-y-3">
            <div class="flex items-start">
              <input
                type="checkbox"
                id="category_casas"
                name="categories[]"
                value="casas"
                class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <div class="ml-3">
                <label for="category_casas" class="text-sm font-medium text-gray-900">
                  Casas Modulares
                </label>
                <p class="text-sm text-gray-500">Modelos de casas modulares/prefabricadas para venta</p>
              </div>
            </div>

            <div class="flex items-start">
              <input
                type="checkbox"
                id="category_fabrica"
                name="categories[]"
                value="fabrica"
                class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <div class="ml-3">
                <label for="category_fabrica" class="text-sm font-medium text-gray-900">
                  Fábrica
                </label>
                <p class="text-sm text-gray-500">Empresa que construye casas modulares/prefabricadas</p>
              </div>
            </div>

            <div class="flex items-start">
              <input
                type="checkbox"
                id="category_servicios"
                name="categories[]"
                value="habilitacion_servicios"
                class="mt-1 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              />
              <div class="ml-3">
                <label for="category_servicios" class="text-sm font-medium text-gray-900">
                  Habilitación y Servicios
                </label>
                <p class="text-sm text-gray-500">Contratistas especialistas en servicios básicos e instalación</p>
              </div>
            </div>

          </div>
          <p class="mt-4 text-sm text-gray-600">
            <strong>Nota:</strong> Un proveedor puede ofrecer múltiples categorías. La primera seleccionada será la categoría principal.
          </p>
        </div>
      </div>

      <!-- Business Details -->
      <div class="bg-white rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-900">Detalles del Negocio</h3>
        </div>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="years_experience" class="block text-sm font-medium text-gray-700 mb-2">
              Años de Experiencia
            </label>
            <input
              type="number"
              id="years_experience"
              name="years_experience"
              min="0"
              max="100"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: 15"
            />
          </div>

          <div>
            <label for="whatsapp" class="block text-sm font-medium text-gray-700 mb-2">
              WhatsApp
            </label>
            <input
              type="tel"
              id="whatsapp"
              name="whatsapp"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="+56 9 8765 4321"
            />
          </div>

          <div class="md:col-span-2">
            <label for="specialties" class="block text-sm font-medium text-gray-700 mb-2">
              Especialidades (separadas por comas)
            </label>
            <input
              type="text"
              id="specialties"
              name="specialties"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: Paneles SIP, Construcción Sustentable, Casas Modulares"
            />
          </div>

          <div class="md:col-span-2">
            <label for="services_offered" class="block text-sm font-medium text-gray-700 mb-2">
              Servicios Ofrecidos (separados por comas)
            </label>
            <input
              type="text"
              id="services_offered"
              name="services_offered"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: Llave en Mano, Diseño Personalizado, Financiamiento"
            />
          </div>

          <div class="md:col-span-2">
            <label for="coverage_areas" class="block text-sm font-medium text-gray-700 mb-2">
              Áreas de Cobertura (separadas por comas)
            </label>
            <input
              type="text"
              id="coverage_areas"
              name="coverage_areas"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: Región Metropolitana, Valparaíso, Biobío"
            />
          </div>

          <div>
            <label for="price_range_min" class="block text-sm font-medium text-gray-700 mb-2">
              Precio Mínimo (CLP)
            </label>
            <input
              type="number"
              id="price_range_min"
              name="price_range_min"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: 45000000"
            />
          </div>

          <div>
            <label for="price_range_max" class="block text-sm font-medium text-gray-700 mb-2">
              Precio Máximo (CLP)
            </label>
            <input
              type="number"
              id="price_range_max"
              name="price_range_max"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: 200000000"
            />
          </div>

          <div>
            <label for="price_per_m2_min" class="block text-sm font-medium text-gray-700 mb-2">
              Precio por m² Mínimo (CLP)
            </label>
            <input
              type="number"
              id="price_per_m2_min"
              name="price_per_m2_min"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: 65000"
            />
          </div>

          <div>
            <label for="price_per_m2_max" class="block text-sm font-medium text-gray-700 mb-2">
              Precio por m² Máximo (CLP)
            </label>
            <input
              type="number"
              id="price_per_m2_max"
              name="price_per_m2_max"
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              placeholder="Ej: 120000"
            />
          </div>

          <div class="md:col-span-2">
            <div class="flex items-center space-x-6">
              <label class="flex items-center">
                <input type="checkbox" name="llave_en_mano" value="true" class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700">Ofrece Llave en Mano</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" name="financing_available" value="true" class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700">Ofrece Financiamiento</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Features -->
      <div class="bg-white rounded-lg border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-medium text-gray-900">Características y Especialidades</h3>
          <p class="text-gray-600 text-sm mt-1">Selecciona las características que aplican a este proveedor</p>
        </div>
        <div class="p-6">
          <div id="features-container">
            <!-- Features will be populated based on selected category -->
            <p class="text-gray-500 text-sm">Selecciona una categoría primero para ver las características disponibles.</p>
          </div>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex justify-end space-x-4">
        <a
          href="/admin/providers"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          Cancelar
        </a>
        <button
          type="submit"
          class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          Crear Proveedor
        </button>
      </div>
    </form>

    <!-- Important Notice -->
    <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
      <div class="flex items-start">
        <svg class="w-5 h-5 text-yellow-400 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
        </svg>
        <div>
          <p class="text-yellow-800 font-medium">Importante</p>
          <p class="text-yellow-700 text-sm mt-1">
            Al crear un proveedor, se enviará un email con las credenciales de acceso. 
            El proveedor deberá cambiar la contraseña en su primer inicio de sesión.
          </p>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script is:inline define:vars={{ features, categories, featuresByCategory }}>
  function generatePassword() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
    let password = '';
    for (let i = 0; i < 12; i++) {
      password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    const passwordInput = document.getElementById('temp_password');
    if (passwordInput) {
      passwordInput.value = password;
    }
  }

  function showMessage(type, message) {
    const successDiv = document.getElementById('successMessage');
    const errorDiv = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    
    if (type === 'success') {
      successDiv?.classList.remove('hidden');
      errorDiv?.classList.add('hidden');
    } else if (message) {
      errorDiv?.classList.remove('hidden');
      successDiv?.classList.add('hidden');
      if (errorText) {
        errorText.textContent = message;
      }
    }
  }

  function hideMessages() {
    const successDiv = document.getElementById('successMessage');
    const errorDiv = document.getElementById('errorMessage');
    successDiv?.classList.add('hidden');
    errorDiv?.classList.add('hidden');
  }

  // Handle form submission
  const createForm = document.getElementById('createProviderForm');
  if (createForm) {
    createForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessages();

      const target = e.target;
      const formData = new FormData(target);
      const submitButton = target.querySelector('button[type="submit"]');
      const originalText = submitButton?.textContent || 'Crear Proveedor';

      // Collect services
      const serviceElements = document.querySelectorAll('input[name="services"]:checked');
      const services = Array.from(serviceElements).map(cb => cb.value);

      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Creando...';
      }

      try {
        // Collect selected features
        const featureElements = document.querySelectorAll('input[name^="feature_"]:checked');
        const features = {};
        featureElements.forEach(el => {
          const featureSlug = el.name.replace('feature_', '');
          features[featureSlug] = true;
        });

        // Parse arrays from comma-separated strings
        const parseArray = (value) => {
          if (!value) return [];
          return value.split(',').map(s => s.trim()).filter(s => s.length > 0);
        };

        // Collect selected categories
        const selectedCategories = [];
        const categoryCheckboxes = target.querySelectorAll('input[name="categories[]"]:checked');
        categoryCheckboxes.forEach(checkbox => {
          selectedCategories.push(checkbox.value);
        });

        if (selectedCategories.length === 0) {
          showMessage('error', 'Por favor seleccione al menos una categoría');
          return;
        }

        const providerData = {
          company_name: formData.get('company_name'),
          email: formData.get('email'),
          phone: formData.get('phone'),
          categories: selectedCategories, // Array of categories
          category_type: selectedCategories[0], // Primary category for backward compatibility
          description: formData.get('description'),
          website: formData.get('website'),
          whatsapp: formData.get('whatsapp'),
          address: formData.get('address'),
          city: formData.get('city'),
          region: formData.get('region'),
          years_experience: formData.get('years_experience'),
          specialties: parseArray(formData.get('specialties')),
          services_offered: parseArray(formData.get('services_offered')),
          coverage_areas: parseArray(formData.get('coverage_areas')),
          price_range_min: formData.get('price_range_min'),
          price_range_max: formData.get('price_range_max'),
          price_per_m2_min: formData.get('price_per_m2_min'),
          price_per_m2_max: formData.get('price_per_m2_max'),
          llave_en_mano: formData.get('llave_en_mano') === 'true',
          financing_available: formData.get('financing_available') === 'true',
          features: features,
          tier: formData.get('tier'),
          status: formData.get('status'),
          temp_password: formData.get('temp_password'),
          admin_notes: formData.get('admin_notes')
        };

        const response = await fetch('/api/admin/providers/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(providerData)
        });

        const result = await response.json();

        if (result.success) {
          showMessage('success');
          // Reset form
          target.reset();
          // Redirect to provider list after 2 seconds
          setTimeout(() => {
            window.location.href = '/admin/providers';
          }, 2000);
        } else {
          showMessage('error', result.error || 'Error al crear el proveedor');
        }

      } catch (error) {
        console.log({error})
        showMessage('error', 'Error de conexión. Inténtalo de nuevo.');
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      }
    });
  }

  // Features data from server
  const featuresData = features || [];
  const categoriesData = categories || [];
  const featuresByCategoryData = featuresByCategory || {};

  // Handle category checkboxes change to show relevant features
  const categoryCheckboxes = document.querySelectorAll('input[name="categories[]"]');
  const featuresContainer = document.getElementById('features-container');

  if (categoryCheckboxes && featuresContainer) {
    categoryCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        updateFeaturesForCategories();
      });
    });
  }

  function updateFeaturesForCategories() {
    const selectedCategories = [];
    categoryCheckboxes.forEach(checkbox => {
      if (checkbox.checked) {
        selectedCategories.push(checkbox.value);
      }
    });
    // Show features for first selected category
    if (selectedCategories.length > 0) {
      updateFeatures(selectedCategories[0]);
    } else {
      updateFeatures('');
    }
  }

  function updateFeatures(categoryType) {
    const container = document.getElementById('features-container');
    if (!container) return;

    // Find the category ID
    const category = categoriesData.find((cat) => cat.type === categoryType);
    
    if (!category) {
      container.innerHTML = '<p class="text-gray-500 text-sm">Selecciona una categoría válida.</p>';
      return;
    }

    const categoryFeatures = featuresByCategoryData[category.id] || [];

    if (categoryFeatures.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-sm">No hay características específicas para esta categoría.</p>';
      return;
    }

    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
    
    categoryFeatures.forEach((feature) => {
      html += `
        <label class="flex items-start space-x-2">
          <input 
            type="checkbox" 
            name="feature_${feature.slug}" 
            value="true" 
            class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500 mt-0.5"
          >
          <div>
            <span class="text-sm font-medium text-gray-700">${feature.name}</span>
            ${feature.show_in_card_premium ? '<span class="text-xs text-blue-600 block">Visible en tarjeta premium</span>' : ''}
          </div>
        </label>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
  }

  // Make functions global so they can be called from onclick attributes
  window.generatePassword = generatePassword;
  window.updateFeatures = updateFeatures;
</script>
