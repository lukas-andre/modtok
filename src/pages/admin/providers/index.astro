---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getAdminAuth, requireAdmin } from '../../../lib/auth';
import { createSupabaseClient } from '../../../lib/supabase';
import type { Database } from '../../../lib/database.types';

// Protect this page - only admins can access
const auth = await getAdminAuth(Astro);
const user = requireAdmin(auth);

if (!user) {
  return Astro.redirect('/auth/login?redirect=/admin/providers');
}

// Get initial page parameters
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const status = (Astro.url.searchParams.get('status') || '') as Database["public"]["Enums"]["listing_status"] | '';
const tier = (Astro.url.searchParams.get('tier') || '') as Database["public"]["Enums"]["listing_tier"] | '';
const search = Astro.url.searchParams.get('search') || '';

// Fetch providers with pagination and filters
const supabase = createSupabaseClient(Astro);
let query = supabase
  .from('providers')
  .select(`
    *,
    profile:profiles!providers_profile_id_fkey(full_name, email, avatar_url),
    approved_by_profile:profiles!providers_approved_by_fkey(full_name, email),
    created_by_profile:profiles!providers_created_by_fkey(full_name, email),
    provider_categories(category_type)
  `, { count: 'exact' });

// Apply filters
if (status) {
  query = query.eq('status', status as Database["public"]["Enums"]["listing_status"]);
}
if (tier) {
  query = query.eq('tier', tier as Database["public"]["Enums"]["listing_tier"]);
}
if (search) {
  query = query.or(`company_name.ilike.%${search}%,email.ilike.%${search}%,description.ilike.%${search}%`);
}

// Apply pagination
const limit = 20;
const offset = (page - 1) * limit;
query = query.order('created_at', { ascending: false }).range(offset, offset + limit - 1);

const { data: providers, error, count } = await query;

if (error) {
  console.error('Error fetching providers:', error);
}

// Calculate pagination info
const totalPages = Math.ceil((count || 0) / limit);
const hasNextPage = page < totalPages;
const hasPrevPage = page > 1;

// Calculate page numbers for pagination buttons
const pageNumbers = [];
const maxVisiblePages = Math.min(5, totalPages);

for (let i = 0; i < maxVisiblePages; i++) {
  let pageNum;
  if (totalPages <= 5) {
    pageNum = i + 1;
  } else if (page <= 3) {
    pageNum = i + 1;
  } else if (page >= totalPages - 2) {
    pageNum = totalPages - 4 + i;
  } else {
    pageNum = page - 2 + i;
  }
  pageNumbers.push(pageNum);
}

// Helper function to format category names
const formatCategoryName = (categoryType: string) => {
  const categoryNames: Record<string, string> = {
    'casas': 'Casas Modulares',
    'fabrica': 'Fábrica',
    'habilitacion_servicios': 'Habilitación y Servicios'
  };
  return categoryNames[categoryType] || categoryType;
};

// Helper function to get category color
const getCategoryColor = (categoryType: string) => {
  const colors: Record<string, string> = {
    'casas': 'bg-purple-100 text-purple-800',
    'fabrica': 'bg-blue-100 text-blue-800',
    'habilitacion_servicios': 'bg-green-100 text-green-800'
  };
  return colors[categoryType] || 'bg-gray-100 text-gray-800';
};
---

<AdminLayout title="Gestión de Proveedores" user={user} currentPage="/admin/providers">
  <div class="p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <div>
        <h2 class="text-xl font-semibold text-gray-900">Gestión de Proveedores</h2>
        <p class="text-gray-600 mt-1">Administra los proveedores de la plataforma MODTOK</p>
      </div>
      <a 
        href="/admin/providers/create"
        class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"
      >
        + Crear Proveedor
      </a>
    </div>

    <!-- Filters & Actions -->
    <form method="GET" class="bg-white p-4 rounded-lg border border-gray-200 mb-6">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="flex flex-wrap items-center gap-4">
          <div class="flex items-center space-x-2">
            <label for="status" class="text-sm font-medium text-gray-700">Estado:</label>
            <select name="status" id="status" class="border border-gray-300 rounded px-3 py-1 text-sm">
              <option value="">Todos</option>
              <option value="active" selected={status === 'active'}>Activo</option>
              <option value="pending_review" selected={status === 'pending_review'}>Pendiente</option>
              <option value="inactive" selected={status === 'inactive'}>Inactivo</option>
              <option value="rejected" selected={status === 'rejected'}>Rechazado</option>
            </select>
          </div>
          
          <div class="flex items-center space-x-2">
            <label for="tier" class="text-sm font-medium text-gray-700">Nivel:</label>
            <select name="tier" id="tier" class="border border-gray-300 rounded px-3 py-1 text-sm">
              <option value="">Todos</option>
              <option value="standard" selected={tier === 'standard'}>Estándar</option>
              <option value="premium" selected={tier === 'premium'}>Premium</option>
              <option value="destacado" selected={tier === 'destacado'}>Destacado</option>
            </select>
          </div>
          
          <div class="flex items-center space-x-2">
            <input
              type="text"
              name="search"
              id="search"
              placeholder="Buscar por nombre o email..."
              class="border border-gray-300 rounded px-3 py-1 text-sm w-64"
              value={search}
            />
          </div>
          
          <button type="submit" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
            Filtrar
          </button>
          
          {(status || tier || search) && (
            <a href="/admin/providers" class="px-3 py-1 text-sm text-gray-600 hover:text-gray-900">
              Limpiar
            </a>
          )}
        </div>
        
        <!-- Bulk Actions -->
        <div class="flex items-center space-x-2">
          <select id="bulk_action" class="border border-gray-300 rounded px-3 py-1 text-sm" disabled>
            <option value="">Acciones en lote...</option>
            <option value="approve">Aprobar seleccionados</option>
            <option value="reject">Rechazar seleccionados</option>
            <option value="change_tier">Cambiar nivel</option>
            <option value="set_featured">Configurar destacados</option>
          </select>
          <button
            type="button"
            id="apply_bulk"
            class="px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Aplicar
          </button>
        </div>
      </div>
    </form>

    <!-- Providers List -->
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
          <h3 class="text-lg font-medium text-gray-900">Lista de Proveedores</h3>
          <span class="text-sm text-gray-500">
            {providers ? `${providers.length} de ${count || 0} proveedores` : 'Cargando...'}
          </span>
        </div>
      </div>
      
      {!providers || providers.length === 0 ? (
        <div class="p-8 text-center">
          <div class="text-gray-400 mb-4">
            <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H9m0 0H5m4 0v-5a1 1 0 011-1h4a1 1 0 011 1v5m-4-5V9a1 1 0 011-1h2a1 1 0 011 1v4.01" />
            </svg>
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No hay proveedores</h3>
          <p class="text-gray-600 mb-4">Crea el primer proveedor de la plataforma.</p>
          <a 
            href="/admin/providers/create"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700"
          >
            Crear Proveedor
          </a>
        </div>
      ) : (
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left">
                  <input
                    type="checkbox"
                    id="select_all"
                    class="rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500"
                    onchange="toggleSelectAll(this)"
                  />
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Proveedor
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Categoría
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Contacto
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Nivel
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Estado
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Métricas
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Acciones
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {providers.map((provider) => (
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <input
                      type="checkbox"
                      class="provider-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:ring-blue-500"
                      value={provider.id}
                      onchange="updateBulkActions()"
                    />
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="flex-shrink-0 h-12 w-12">
                        {provider.logo_url ? (
                          <img class="h-12 w-12 rounded-lg object-cover" src={provider.logo_url} alt="" />
                        ) : (
                          <div class="h-12 w-12 rounded-lg bg-gray-300 flex items-center justify-center">
                            <span class="text-sm font-medium text-gray-700">
                              {provider.company_name?.charAt(0)?.toUpperCase() || '?'}
                            </span>
                          </div>
                        )}
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900">
                          <a href={`/admin/providers/${provider.id}`} class="hover:text-blue-600">
                            {provider.company_name}
                          </a>
                        </div>
                        <div class="text-sm text-gray-500">
                          {provider.years_experience ? `${provider.years_experience} años exp.` : ''}
                          {provider.specialties && provider.specialties.length > 0 && (
                            <span class="ml-2 text-xs text-blue-600">
                              {provider.specialties.slice(0, 2).join(', ')}
                              {provider.specialties.length > 2 && '...'}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex flex-wrap gap-1">
                      {provider.provider_categories?.length > 0 ? (
                        provider.provider_categories.map((pc: any) => (
                          <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getCategoryColor(pc.category_type)}`}>
                            {formatCategoryName(pc.category_type)}
                          </span>
                        ))
                      ) : (
                        <span class="text-xs text-gray-500">Sin categorías</span>
                      )}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">{provider.email}</div>
                    <div class="text-sm text-gray-500">{provider.phone}</div>
                    <div class="text-sm text-gray-500">{provider.city}, {provider.region}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-col space-y-1">
                      <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                        provider.tier === 'destacado' 
                          ? 'bg-yellow-100 text-yellow-800' 
                          : provider.tier === 'premium'
                          ? 'bg-purple-100 text-purple-800'
                          : 'bg-gray-100 text-gray-800'
                      }`}>
                        {provider.tier === 'destacado' ? 'Destacado' : 
                         provider.tier === 'premium' ? 'Premium' : 'Estándar'}
                      </span>
                      {provider.internal_rating && (
                        <div class="flex items-center">
                          {Array.from({length: 5}).map((_, i) => (
                            <svg 
                              class={`w-3 h-3 ${i < (provider.internal_rating || 0) ? 'text-yellow-400' : 'text-gray-300'}`} 
                              fill="currentColor" 
                              viewBox="0 0 20 20"
                            >
                              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                          ))}
                        </div>
                      )}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                      provider.status === 'active' 
                        ? 'bg-green-100 text-green-800' 
                        : provider.status === 'pending_review'
                        ? 'bg-yellow-100 text-yellow-800'
                        : provider.status === 'inactive'
                        ? 'bg-gray-100 text-gray-800'
                        : 'bg-red-100 text-red-800'
                    }`}>
                      {provider.status === 'active' ? 'Activo' : 
                       provider.status === 'pending_review' ? 'Pendiente' : 
                       provider.status === 'inactive' ? 'Inactivo' : 
                       provider.status === 'rejected' ? 'Rechazado' : 'Borrador'}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500">
                    <div class="space-y-1">
                      <div>👁️ {provider.views_count || 0}</div>
                      <div>📞 {provider.inquiries_count || 0}</div>
                      <div>👆 {provider.clicks_count || 0}</div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-2">
                      <a 
                        href={`/admin/providers/${provider.id}`}
                        class="text-blue-600 hover:text-blue-900"
                      >
                        Ver
                      </a>
                      <a 
                        href={`/admin/providers/${provider.id}/edit`}
                        class="text-indigo-600 hover:text-indigo-900"
                      >
                        Editar
                      </a>
                      {provider.status === 'pending_review' && (
                        <button 
                          onclick={`quickApprove('${provider.id}')`}
                          class="text-green-600 hover:text-green-900"
                        >
                          Aprobar
                        </button>
                      )}
                      {user.role === 'super_admin' && (
                        <button 
                          onclick={`deleteProvider('${provider.id}', '${provider.company_name}')`}
                          class="text-red-600 hover:text-red-900"
                        >
                          Eliminar
                        </button>
                      )}
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}  
    </div>
    
    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="mt-6 flex items-center justify-between">
        <div class="text-sm text-gray-700">
          Mostrando página {page} de {totalPages} ({count || 0} proveedores total)
        </div>
        <div class="flex space-x-2">
          {hasPrevPage && (
            <a
              href={`?page=${page - 1}${status ? `&status=${status}` : ''}${tier ? `&tier=${tier}` : ''}${search ? `&search=${search}` : ''}`}
              class="px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-50"
            >
              Anterior
            </a>
          )}
          
{pageNumbers.map((pageNum) => (
            <a
              href={`?page=${pageNum}${status ? `&status=${status}` : ''}${tier ? `&tier=${tier}` : ''}${search ? `&search=${search}` : ''}`}
              class={`px-3 py-1 text-sm rounded ${
                pageNum === page
                  ? 'bg-blue-600 text-white'
                  : 'bg-white border border-gray-300 hover:bg-gray-50'
              }`}
            >
              {pageNum}
            </a>
          ))}
          
          {hasNextPage && (
            <a
              href={`?page=${page + 1}${status ? `&status=${status}` : ''}${tier ? `&tier=${tier}` : ''}${search ? `&search=${search}` : ''}`}
              class="px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-50"
            >
              Siguiente
            </a>
          )}
        </div>
      </div>
    )}
  </div>
</AdminLayout>

<script>
  async function quickApprove(providerId: string): Promise<void> {
    if (!confirm('¿Confirmas que deseas aprobar este proveedor?')) return;

    try {
      const response = await fetch('/api/admin/providers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'approve',
          provider_ids: [providerId]
        })
      });

      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error al aprobar proveedor: ' + result.message);
      }
    } catch (error) {
      alert('Error de conexión al aprobar proveedor');
    }
  }

  async function deleteProvider(providerId: string, providerName: string): Promise<void> {
    if (!confirm(`¿Estás seguro que deseas eliminar al proveedor "${providerName}"? Esta acción no se puede deshacer.`)) return;

    try {
      const response = await fetch(`/api/admin/providers/${providerId}`, {
        method: 'DELETE'
      });

      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error al eliminar proveedor: ' + result.error);
      }
    } catch (error) {
      alert('Error de conexión al eliminar proveedor');
    }
  }

  function toggleSelectAll(checkbox: HTMLInputElement): void {
    const providerCheckboxes = document.querySelectorAll('.provider-checkbox') as NodeListOf<HTMLInputElement>;
    providerCheckboxes.forEach(cb => {
      cb.checked = checkbox.checked;
    });
    updateBulkActions();
  }

  function updateBulkActions(): void {
    const checkedBoxes = document.querySelectorAll('.provider-checkbox:checked');
    const bulkAction = document.getElementById('bulk_action') as HTMLSelectElement;
    const applyButton = document.getElementById('apply_bulk') as HTMLButtonElement;
    
    const hasSelection = checkedBoxes.length > 0;
    bulkAction.disabled = !hasSelection;
    applyButton.disabled = !hasSelection;
  }

  async function applyBulkAction(): Promise<void> {
    const checkedBoxes = document.querySelectorAll('.provider-checkbox:checked') as NodeListOf<HTMLInputElement>;
    const bulkAction = document.getElementById('bulk_action') as HTMLSelectElement;
    
    if (checkedBoxes.length === 0 || !bulkAction.value) {
      alert('Selecciona proveedores y una acción');
      return;
    }

    const providerIds = Array.from(checkedBoxes).map(cb => cb.value);
    const action = bulkAction.value;
    
    let confirmMessage = `¿Confirmas aplicar "${bulkAction.selectedOptions[0].textContent}" a ${providerIds.length} proveedores?`;
    if (!confirm(confirmMessage)) return;

    try {
      const response = await fetch('/api/admin/providers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: action,
          provider_ids: providerIds
        })
      });

      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Error en operación en lote: ' + result.message);
      }
    } catch (error) {
      alert('Error de conexión en operación en lote');
    }
  }

  // Setup bulk actions
  document.addEventListener('DOMContentLoaded', function() {
    const applyButton = document.getElementById('apply_bulk');
    if (applyButton) {
      applyButton.addEventListener('click', applyBulkAction);
    }
  });

  // Make functions global so they can be called from onclick attributes
  (window as any).quickApprove = quickApprove;
  (window as any).deleteProvider = deleteProvider;
  (window as any).toggleSelectAll = toggleSelectAll;
  (window as any).updateBulkActions = updateBulkActions;
</script>
